<!DOCTYPE html>
<html>
<head>
    <title>ViralSplit - YouTube Processing Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; }
        .progress-ring { width: 100px; height: 100px; margin: 20px auto; }
        .progress-value { font-size: 18px; font-weight: bold; text-align: center; margin: 10px 0; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; text-align: center; }
        .processing { background: #fff3cd; color: #856404; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé• ViralSplit - YouTube Processing</h1>
        <p><strong>Status:</strong> API Fixed & Working ‚úÖ</p>
        
        <div>
            <label>YouTube URL:</label>
            <input type="url" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=..." 
                   value="https://www.youtube.com/watch?v=dQw4w9WgXcQ">
        </div>
        
        <button id="processBtn" onclick="processYouTube()">Process Video</button>
        <button onclick="clearResults()">Clear</button>
        
        <div class="progress-ring">
            <svg width="100" height="100">
                <circle cx="50" cy="50" r="40" stroke="#e6e6e6" stroke-width="8" fill="none"/>
                <circle id="progressCircle" cx="50" cy="50" r="40" stroke="#007bff" stroke-width="8" 
                        fill="none" stroke-dasharray="251.2" stroke-dashoffset="251.2" 
                        style="transform: rotate(-90deg); transform-origin: 50px 50px; transition: stroke-dashoffset 0.5s;"/>
            </svg>
        </div>
        <div class="progress-value" id="progressValue">0%</div>
        
        <div id="status" class="status">Ready to process YouTube video</div>
        
        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <script>
        let pollInterval;
        
        function updateProgress(progress) {
            const circle = document.getElementById('progressCircle');
            const value = document.getElementById('progressValue');
            const circumference = 251.2;
            const offset = circumference - (progress / 100) * circumference;
            
            circle.style.strokeDashoffset = offset;
            value.textContent = Math.round(progress) + '%';
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('status').className = 'status';
            document.getElementById('status').textContent = 'Ready to process YouTube video';
            updateProgress(0);
            if (pollInterval) clearInterval(pollInterval);
            document.getElementById('processBtn').disabled = false;
        }
        
        async function processYouTube() {
            const url = document.getElementById('youtubeUrl').value;
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            const processBtn = document.getElementById('processBtn');
            
            if (!url || !url.includes('youtube.com')) {
                alert('Please enter a valid YouTube URL');
                return;
            }
            
            processBtn.disabled = true;
            statusDiv.className = 'status processing';
            statusDiv.textContent = 'Starting YouTube processing...';
            updateProgress(0);
            resultsDiv.innerHTML = '';
            
            try {
                // Step 1: Submit YouTube URL
                const response = await fetch('https://api.viralsplit.io/api/upload/youtube', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        agreed_to_terms: true,
                        is_trial: true
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                }
                
                const data = await response.json();
                const projectId = data.project_id;
                
                statusDiv.textContent = `Processing started (ID: ${projectId.substring(0, 8)}...)`;
                updateProgress(5);
                
                // Step 2: Poll for progress
                let pollCount = 0;
                pollInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`https://api.viralsplit.io/api/projects/${projectId}/status`);
                        const statusData = await statusResponse.json();
                        
                        updateProgress(statusData.progress || 0);
                        statusDiv.textContent = `${statusData.message || statusData.status} (${statusData.progress || 0}%)`;
                        
                        if (statusData.status === 'ready_for_processing' || statusData.progress >= 100) {
                            clearInterval(pollInterval);
                            statusDiv.className = 'status success';
                            statusDiv.textContent = '‚úÖ Processing completed successfully!';
                            updateProgress(100);
                            
                            resultsDiv.innerHTML = `
                                <h3>‚úÖ Success!</h3>
                                <p><strong>Project ID:</strong> ${projectId}</p>
                                <p><strong>YouTube URL:</strong> ${statusData.youtube_url}</p>
                                <p><strong>Status:</strong> ${statusData.status}</p>
                                <p><strong>Message:</strong> ${statusData.message}</p>
                                <p><em>Video is ready for platform optimization!</em></p>
                            `;
                            processBtn.disabled = false;
                        } else if (statusData.status === 'failed' || statusData.status === 'error') {
                            clearInterval(pollInterval);
                            statusDiv.className = 'status error';
                            statusDiv.textContent = `‚ùå Processing failed: ${statusData.error || statusData.status}`;
                            processBtn.disabled = false;
                        }
                        
                        pollCount++;
                        if (pollCount > 30) {
                            clearInterval(pollInterval);
                            statusDiv.className = 'status error';
                            statusDiv.textContent = '‚è∞ Processing timeout after 60 seconds';
                            processBtn.disabled = false;
                        }
                        
                    } catch (pollError) {
                        console.error('Poll error:', pollError);
                    }
                }, 2000);
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
                processBtn.disabled = false;
                console.error('Processing error:', error);
            }
        }
    </script>
</body>
</html>